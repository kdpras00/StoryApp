/*! For license information please see main~1832b828.bundle.js.LICENSE.txt */
"use strict";(self.webpackChunkstory_sharing_app=self.webpackChunkstory_sharing_app||[]).push([[690],{122:(e,r,t)=>{function n(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);r&&(n=n.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,n)}return t}function o(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?n(Object(t),!0).forEach((function(r){a(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):n(Object(t)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}function a(e,r,t){return(r=y(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function s(e,r){return function(e){if(Array.isArray(e))return e}(e)||function(e,r){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var n,o,a,s,i=[],c=!0,u=!1;try{if(a=(t=t.call(e)).next,0===r){if(Object(t)!==t)return;c=!1}else for(;!(c=(n=a.call(t)).done)&&(i.push(n.value),i.length!==r);c=!0);}catch(e){u=!0,o=e}finally{try{if(!c&&null!=t.return&&(s=t.return(),Object(s)!==s))return}finally{if(u)throw o}}return i}}(e,r)||u(e,r)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}function c(e,r){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=u(e))||r&&e&&"number"==typeof e.length){t&&(e=t);var n=0,o=function(){};return{s:o,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,i=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return s=e.done,e},e:function(e){i=!0,a=e},f:function(){try{s||null==t.return||t.return()}finally{if(i)throw a}}}}function u(e,r){if(e){if("string"==typeof e)return f(e,r);var t={}.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?f(e,r):void 0}}function f(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=Array(r);t<r;t++)n[t]=e[t];return n}function l(){l=function(){return r};var e,r={},t=Object.prototype,n=t.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",c=o.toStringTag||"@@toStringTag";function u(e,r,t,n){return Object.defineProperty(e,r,{value:t,enumerable:!n,configurable:!n,writable:!n})}try{u({},"")}catch(e){u=function(e,r,t){return e[r]=t}}function f(r,t,n,o){var a=t&&t.prototype instanceof p?t:p,s=Object.create(a.prototype);return u(s,"_invoke",function(r,t,n){var o=1;return function(a,s){if(3===o)throw Error("Generator is already running");if(4===o){if("throw"===a)throw s;return{value:e,done:!0}}for(n.method=a,n.arg=s;;){var i=n.delegate;if(i){var c=S(i,n);if(c){if(c===h)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(1===o)throw o=4,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=3;var u=d(r,t,n);if("normal"===u.type){if(o=n.done?4:2,u.arg===h)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=4,n.method="throw",n.arg=u.arg)}}}(r,n,new E(o||[])),!0),s}function d(e,r,t){try{return{type:"normal",arg:e.call(r,t)}}catch(e){return{type:"throw",arg:e}}}r.wrap=f;var h={};function p(){}function y(){}function v(){}var b={};u(b,a,(function(){return this}));var g=Object.getPrototypeOf,m=g&&g(g(j([])));m&&m!==t&&n.call(m,a)&&(b=m);var x=v.prototype=p.prototype=Object.create(b);function w(e){["next","throw","return"].forEach((function(r){u(e,r,(function(e){return this._invoke(r,e)}))}))}function k(e,r){function t(o,a,s,c){var u=d(e[o],e,a);if("throw"!==u.type){var f=u.arg,l=f.value;return l&&"object"==i(l)&&n.call(l,"__await")?r.resolve(l.__await).then((function(e){t("next",e,s,c)}),(function(e){t("throw",e,s,c)})):r.resolve(l).then((function(e){f.value=e,s(f)}),(function(e){return t("throw",e,s,c)}))}c(u.arg)}var o;u(this,"_invoke",(function(e,n){function a(){return new r((function(r,o){t(e,n,r,o)}))}return o=o?o.then(a,a):a()}),!0)}function S(r,t){var n=t.method,o=r.i[n];if(o===e)return t.delegate=null,"throw"===n&&r.i.return&&(t.method="return",t.arg=e,S(r,t),"throw"===t.method)||"return"!==n&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+n+"' method")),h;var a=d(o,r.i,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,h;var s=a.arg;return s?s.done?(t[r.r]=s.value,t.next=r.n,"return"!==t.method&&(t.method="next",t.arg=e),t.delegate=null,h):s:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,h)}function I(e){this.tryEntries.push(e)}function A(r){var t=r[4]||{};t.type="normal",t.arg=e,r[4]=t}function E(e){this.tryEntries=[[-1]],e.forEach(I,this),this.reset(!0)}function j(r){if(null!=r){var t=r[a];if(t)return t.call(r);if("function"==typeof r.next)return r;if(!isNaN(r.length)){var o=-1,s=function t(){for(;++o<r.length;)if(n.call(r,o))return t.value=r[o],t.done=!1,t;return t.value=e,t.done=!0,t};return s.next=s}}throw new TypeError(i(r)+" is not iterable")}return y.prototype=v,u(x,"constructor",v),u(v,"constructor",y),y.displayName=u(v,c,"GeneratorFunction"),r.isGeneratorFunction=function(e){var r="function"==typeof e&&e.constructor;return!!r&&(r===y||"GeneratorFunction"===(r.displayName||r.name))},r.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,u(e,c,"GeneratorFunction")),e.prototype=Object.create(x),e},r.awrap=function(e){return{__await:e}},w(k.prototype),u(k.prototype,s,(function(){return this})),r.AsyncIterator=k,r.async=function(e,t,n,o,a){void 0===a&&(a=Promise);var s=new k(f(e,t,n,o),a);return r.isGeneratorFunction(t)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},w(x),u(x,c,"Generator"),u(x,a,(function(){return this})),u(x,"toString",(function(){return"[object Generator]"})),r.keys=function(e){var r=Object(e),t=[];for(var n in r)t.unshift(n);return function e(){for(;t.length;)if((n=t.pop())in r)return e.value=n,e.done=!1,e;return e.done=!0,e}},r.values=j,E.prototype={constructor:E,reset:function(r){if(this.prev=this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(A),!r)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0][4];if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(r){if(this.done)throw r;var t=this;function n(e){s.type="throw",s.arg=r,t.next=e}for(var o=t.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a[4],i=this.prev,c=a[1],u=a[2];if(-1===a[0])return n("end"),!1;if(!c&&!u)throw Error("try statement without catch or finally");if(null!=a[0]&&a[0]<=i){if(i<c)return this.method="next",this.arg=e,n(c),!0;if(i<u)return n(u),!1}}},abrupt:function(e,r){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n[0]>-1&&n[0]<=this.prev&&this.prev<n[2]){var o=n;break}}o&&("break"===e||"continue"===e)&&o[0]<=r&&r<=o[2]&&(o=null);var a=o?o[4]:{};return a.type=e,a.arg=r,o?(this.method="next",this.next=o[2],h):this.complete(a)},complete:function(e,r){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&r&&(this.next=r),h},finish:function(e){for(var r=this.tryEntries.length-1;r>=0;--r){var t=this.tryEntries[r];if(t[2]===e)return this.complete(t[4],t[3]),A(t),h}},catch:function(e){for(var r=this.tryEntries.length-1;r>=0;--r){var t=this.tryEntries[r];if(t[0]===e){var n=t[4];if("throw"===n.type){var o=n.arg;A(t)}return o}}throw Error("illegal catch attempt")},delegateYield:function(r,t,n){return this.delegate={i:j(r),r:t,n},"next"===this.method&&(this.arg=e),h}},r}function d(e,r,t,n,o,a,s){try{var i=e[a](s),c=i.value}catch(e){return void t(e)}i.done?r(c):Promise.resolve(c).then(n,o)}function h(e){return function(){var r=this,t=arguments;return new Promise((function(n,o){var a=e.apply(r,t);function s(e){d(a,n,o,s,i,"next",e)}function i(e){d(a,n,o,s,i,"throw",e)}s(void 0)}))}}function p(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,y(n.key),n)}}function y(e){var r=function(e){if("object"!=i(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var t=r.call(e,"string");if("object"!=i(t))return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==i(r)?r:r+""}t.d(r,{A:()=>v}),t(618);const v=function(){return e=function e(){!function(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}(this,e),this.API_BASE_URL="https://story-api.dicoding.dev/v1",this.token=localStorage.getItem("token")||null,this._isLoggedIn=!!this.token,this.stories=[],this.favorites=JSON.parse(localStorage.getItem("favorites"))||[],this.initIndexedDB()},r=[{key:"initIndexedDB",value:(_=h(l().mark((function e(){var r,t=this;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,"indexedDB"in window){e.next=4;break}return console.warn("IndexedDB not supported"),e.abrupt("return");case 4:(r=indexedDB.open("story-app-db",1)).onupgradeneeded=function(e){var r=e.target.result;r.objectStoreNames.contains("stories")||r.createObjectStore("stories",{keyPath:"id"}).createIndex("by-date","createdAt",{unique:!1}),r.objectStoreNames.contains("favorites")||r.createObjectStore("favorites",{keyPath:"id"}),r.objectStoreNames.contains("offlineActions")||r.createObjectStore("offlineActions",{keyPath:"timestamp"}).createIndex("by-type","type",{unique:!1})},r.onsuccess=function(e){t.db=e.target.result,console.log("IndexedDB initialized successfully"),t.syncOfflineData()},r.onerror=function(e){console.error("IndexedDB initialization failed:",e.target.error)},e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),console.error("Error initializing IndexedDB:",e.t0);case 13:case"end":return e.stop()}}),e,null,[[0,10]])}))),function(){return _.apply(this,arguments)})},{key:"saveStoriesToIndexedDB",value:(P=h(l().mark((function e(r){var t,n,o,a,s;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.db){e.next=2;break}return e.abrupt("return");case 2:e.prev=2,t=this.db.transaction("stories","readwrite"),n=t.objectStore("stories"),o=c(r);try{for(o.s();!(a=o.n()).done;)s=a.value,n.put(s)}catch(e){o.e(e)}finally{o.f()}return e.abrupt("return",new Promise((function(e,r){t.oncomplete=function(){return e()},t.onerror=function(e){return r(e.target.error)}})));case 10:e.prev=10,e.t0=e.catch(2),console.error("Error saving stories to IndexedDB:",e.t0);case 13:case"end":return e.stop()}}),e,this,[[2,10]])}))),function(e){return P.apply(this,arguments)})},{key:"getStoriesFromIndexedDB",value:(F=h(l().mark((function e(){var r,t,n;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.db){e.next=2;break}return e.abrupt("return",[]);case 2:return e.prev=2,r=this.db.transaction("stories","readonly"),t=r.objectStore("stories"),n=t.index("by-date"),e.abrupt("return",new Promise((function(e,t){var o=n.getAll();o.onsuccess=function(){var r=Array.isArray(o.result)?o.result:[];e(r)},o.onerror=function(r){console.error("Error in getAll request:",r.target.error),e([])},r.onerror=function(r){console.error("Transaction error:",r.target.error),e([])}})));case 9:return e.prev=9,e.t0=e.catch(2),console.error("Error getting stories from IndexedDB:",e.t0),e.abrupt("return",[]);case 13:case"end":return e.stop()}}),e,this,[[2,9]])}))),function(){return F.apply(this,arguments)})},{key:"saveFavoritesToIndexedDB",value:(O=h(l().mark((function e(r){var t,n,o,a,s;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.db){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,Array.isArray(r)||(console.error("saveFavoritesToIndexedDB received non-array:",r),r=[]),t=this.db.transaction("favorites","readwrite"),n=t.objectStore("favorites"),e.next=8,new Promise((function(e,r){var t=n.clear();t.onsuccess=function(){return e()},t.onerror=function(e){console.error("Error clearing favorites:",e.target.error),r(e.target.error)}}));case 8:o=c(r);try{for(o.s();!(a=o.n()).done;){s=a.value;try{s&&"object"===i(s)&&s.id?n.put(s):console.warn("Skipping invalid favorite:",s)}catch(e){console.error("Error adding favorite item:",e)}}}catch(e){o.e(e)}finally{o.f()}return e.abrupt("return",new Promise((function(e,r){t.oncomplete=function(){return e()},t.onerror=function(e){console.error("Transaction error in saveFavoritesToIndexedDB:",e.target.error),r(e.target.error)}})));case 13:e.prev=13,e.t0=e.catch(2),console.error("Error saving favorites to IndexedDB:",e.t0);case 16:case"end":return e.stop()}}),e,this,[[2,13]])}))),function(e){return O.apply(this,arguments)})},{key:"getFavoritesFromIndexedDB",value:(B=h(l().mark((function e(){var r,t,n;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.db){e.next=2;break}return e.abrupt("return",[]);case 2:return e.prev=2,r=this.db.transaction("favorites","readonly"),t=r.objectStore("favorites"),e.next=7,t.getAll();case 7:return n=e.sent,e.abrupt("return",new Promise((function(e,t){r.oncomplete=function(){return e(n)},r.onerror=function(e){return t(e.target.error)}})));case 11:return e.prev=11,e.t0=e.catch(2),console.error("Error getting favorites from IndexedDB:",e.t0),e.abrupt("return",[]);case 15:case"end":return e.stop()}}),e,this,[[2,11]])}))),function(){return B.apply(this,arguments)})},{key:"addOfflineAction",value:(D=h(l().mark((function e(r,t){var n,o,a;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.db){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,n=this.db.transaction("offlineActions","readwrite"),o=n.objectStore("offlineActions"),a={timestamp:Date.now(),type:r,data:t,synced:!1},o.add(a),e.abrupt("return",new Promise((function(e,r){n.oncomplete=function(){return e()},n.onerror=function(e){return r(e.target.error)}})));case 10:e.prev=10,e.t0=e.catch(2),console.error("Error adding offline action:",e.t0);case 13:case"end":return e.stop()}}),e,this,[[2,10]])}))),function(e,r){return D.apply(this,arguments)})},{key:"syncOfflineData",value:(j=h(l().mark((function e(){var r,t,n,o,a,i,u,f,d,h,p,y,v=this;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.db&&navigator.onLine&&this.isLoggedIn()){e.next=2;break}return e.abrupt("return");case 2:if(e.prev=2,this.db.objectStoreNames.contains("offlineActions")){e.next=6;break}return console.log("offlineActions store doesn't exist yet, skipping sync"),e.abrupt("return");case 6:return r=this.db.transaction("offlineActions","readwrite"),t=r.objectStore("offlineActions"),e.next=10,t.getAll();case 10:n=e.sent,o=c(n),e.prev=12,i=l().mark((function e(){var r,n;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=a.value).synced){e.next=3;break}return e.abrupt("return",1);case 3:e.prev=3,e.t0=r.type,e.next="addStory"===e.t0?7:"toggleFavorite"===e.t0?10:"updateStory"===e.t0?11:"deleteStory"===e.t0?17:21;break;case 7:return e.next=9,v.addStoryOnline(r.data);case 9:case 10:return e.abrupt("break",21);case 11:if(!(r.data&&r.data.storyId&&r.data.updatedData)){e.next=16;break}return n=new FormData,Object.entries(r.data.updatedData).forEach((function(e){var r=s(e,2),t=r[0],o=r[1];null!=o&&n.append(t,o)})),e.next=16,fetch("".concat(v.API_BASE_URL,"/stories/").concat(r.data.storyId),{method:"PUT",headers:{Authorization:"Bearer ".concat(v.token)},body:n});case 16:return e.abrupt("break",21);case 17:if(!r.data||!r.data.storyId){e.next=20;break}return e.next=20,fetch("".concat(v.API_BASE_URL,"/stories/").concat(r.data.storyId),{method:"DELETE",headers:{Authorization:"Bearer ".concat(v.token)}});case 20:return e.abrupt("break",21);case 21:r.synced=!0,t.put(r),e.next=28;break;case 25:e.prev=25,e.t1=e.catch(3),console.error("Error syncing action ".concat(r.type,":"),e.t1);case 28:case"end":return e.stop()}}),e,null,[[3,25]])})),o.s();case 15:if((a=o.n()).done){e.next=21;break}return e.delegateYield(i(),"t0",17);case 17:if(!e.t0){e.next=19;break}return e.abrupt("continue",19);case 19:e.next=15;break;case 21:e.next=26;break;case 23:e.prev=23,e.t1=e.catch(12),o.e(e.t1);case 26:return e.prev=26,o.f(),e.finish(26);case 29:if(e.prev=29,!(t.indexNames&&t.indexNames.contains&&t.indexNames.contains("by-type"))){e.next=37;break}return u=this.db.transaction("offlineActions","readwrite"),f=u.objectStore("offlineActions"),e.next=35,f.index("by-type").getAll(IDBKeyRange.only(!0));case 35:if((d=e.sent)&&d.length){h=c(d);try{for(h.s();!(p=h.n()).done;)y=p.value,f.delete(y.timestamp)}catch(e){h.e(e)}finally{h.f()}}case 37:e.next=42;break;case 39:e.prev=39,e.t2=e.catch(29),console.warn("Error during cleanup of synced actions:",e.t2);case 42:e.next=47;break;case 44:e.prev=44,e.t3=e.catch(2),console.error("Error syncing offline data:",e.t3);case 47:case"end":return e.stop()}}),e,this,[[2,44],[12,23,26,29],[29,39]])}))),function(){return j.apply(this,arguments)})},{key:"login",value:(E=h(l().mark((function e(r,t){var n,o,a,s,c;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,"object"===i(r)&&null!==r?(n=r.email,o=r.password):(n=r,o=t),e.next=4,fetch("".concat(this.API_BASE_URL,"/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:n,password:o})});case 4:return a=e.sent,e.next=7,a.json();case 7:if(!(s=e.sent).error){e.next=10;break}throw new Error(s.message);case 10:return this.token=s.loginResult.token,this._isLoggedIn=!0,localStorage.setItem("token",this.token),e.next=15,this.getFavoritesFromIndexedDB();case 15:return(c=e.sent).length>0&&(this.favorites=c),e.abrupt("return",s);case 20:throw e.prev=20,e.t0=e.catch(0),new Error("Login failed: ".concat(e.t0.message));case 23:case"end":return e.stop()}}),e,this,[[0,20]])}))),function(e,r){return E.apply(this,arguments)})},{key:"register",value:(A=h(l().mark((function e(r,t,n){var o,a;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch("".concat(this.API_BASE_URL,"/register"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:r,email:t,password:n})});case 3:return o=e.sent,e.next=6,o.json();case 6:if(!(a=e.sent).error){e.next=9;break}throw new Error(a.message);case 9:return e.abrupt("return",a);case 12:throw e.prev=12,e.t0=e.catch(0),new Error("Registration failed: ".concat(e.t0.message));case 15:case"end":return e.stop()}}),e,this,[[0,12]])}))),function(e,r,t){return A.apply(this,arguments)})},{key:"logout",value:function(){localStorage.removeItem("token"),this.token=null,this._isLoggedIn=!1,this.stories=[]}},{key:"isLoggedIn",value:function(){return!!this.token}},{key:"getStories",value:(I=h(l().mark((function e(){var r,t;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,this.token){e.next=9;break}return console.warn("No authentication token available"),e.next=5,this.getStoriesFromIndexedDB();case 5:if(e.t0=e.sent,e.t0){e.next=8;break}e.t0=[];case 8:return e.abrupt("return",e.t0);case 9:if(!navigator.onLine){e.next=42;break}return e.prev=10,e.next=13,fetch("".concat(this.API_BASE_URL,"/stories"),{headers:{Authorization:"Bearer ".concat(this.token)}});case 13:if(401!==(r=e.sent).status){e.next=18;break}throw console.error("Authentication failed: Invalid or expired token"),this.logout(),new Error("Authentication failed. Please login again.");case 18:return e.next=20,r.json();case 20:if(!(t=e.sent).error){e.next=23;break}throw new Error(t.message);case 23:if(!Array.isArray(t.listStory)){e.next=30;break}return this.stories=t.listStory,e.next=27,this.saveStoriesToIndexedDB(this.stories);case 27:return e.abrupt("return",this.stories);case 30:throw console.error("API returned non-array listStory:",t),new Error("Invalid data format from API");case 32:e.next=40;break;case 34:if(e.prev=34,e.t1=e.catch(10),console.error("Error fetching stories online:",e.t1),!e.t1.message.includes("Authentication failed")){e.next=39;break}return e.abrupt("return",[]);case 39:throw e.t1;case 40:e.next=48;break;case 42:return console.log("Device is offline, fetching stories from IndexedDB"),e.next=45,this.getStoriesFromIndexedDB();case 45:return this.stories=e.sent,Array.isArray(this.stories)||(console.error("IndexedDB returned non-array stories:",this.stories),this.stories=[]),e.abrupt("return",this.stories);case 48:e.next=66;break;case 50:return e.prev=50,e.t2=e.catch(0),console.error("Error getting stories, falling back to IndexedDB:",e.t2),e.prev=53,e.next=56,this.getStoriesFromIndexedDB();case 56:return this.stories=e.sent,Array.isArray(this.stories)||(console.error("Final fallback: IndexedDB returned non-array:",this.stories),this.stories=[]),e.abrupt("return",this.stories);case 61:return e.prev=61,e.t3=e.catch(53),console.error("Complete failure getting stories:",e.t3),this.stories=[],e.abrupt("return",this.stories);case 66:case"end":return e.stop()}}),e,this,[[0,50],[10,34],[53,61]])}))),function(){return I.apply(this,arguments)})},{key:"fetchStories",value:(S=h(l().mark((function e(){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.getStories());case 1:case"end":return e.stop()}}),e,this)}))),function(){return S.apply(this,arguments)})},{key:"getFavorites",value:(k=h(l().mark((function e(){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.getFavoriteStories());case 1:case"end":return e.stop()}}),e,this)}))),function(){return k.apply(this,arguments)})},{key:"addStory",value:(w=h(l().mark((function e(r){var t,n,o,a,s;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!navigator.onLine){e.next=7;break}return e.next=4,this.addStoryOnline(r);case 4:return e.abrupt("return",e.sent);case 7:return t=r.get("description"),n=r.get("photo"),o=r.get("lat"),a=r.get("lon"),e.next=13,this.addOfflineAction("addStory",{description:t,photo:URL.createObjectURL(n),lat:o,lon:a,createdAt:(new Date).toISOString()});case 13:return s={id:"temp-".concat(Date.now()),description:t,photoUrl:URL.createObjectURL(n),lat:o,lon:a,createdAt:(new Date).toISOString(),name:"You (offline)"},this.stories.unshift(s),e.next=17,this.saveStoriesToIndexedDB(this.stories);case 17:return e.abrupt("return",{error:!1,message:"Story added (offline mode). It will be synced when you're back online."});case 18:e.next=23;break;case 20:throw e.prev=20,e.t0=e.catch(0),new Error("Failed to add story: ".concat(e.t0.message));case 23:case"end":return e.stop()}}),e,this,[[0,20]])}))),function(e){return w.apply(this,arguments)})},{key:"addStoryOnline",value:(x=h(l().mark((function e(r){var t,n;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,fetch("".concat(this.API_BASE_URL,"/stories"),{method:"POST",headers:{Authorization:"Bearer ".concat(this.token)},body:r});case 2:return t=e.sent,e.next=5,t.json();case 5:if(!(n=e.sent).error){e.next=8;break}throw new Error(n.message);case 8:return e.next=10,this.getStories();case 10:return e.abrupt("return",n);case 11:case"end":return e.stop()}}),e,this)}))),function(e){return x.apply(this,arguments)})},{key:"toggleFavorite",value:(m=h(l().mark((function e(r){var t,n,o=this;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((t=this.favorites.includes(r))?this.favorites=this.favorites.filter((function(e){return e!==r})):this.favorites.push(r),localStorage.setItem("favorites",JSON.stringify(this.favorites)),e.prev=3,Array.isArray(this.stories)){e.next=10;break}return console.error("this.stories is not an array in toggleFavorite:",this.stories),e.next=8,this.getStoriesFromIndexedDB();case 8:this.stories=e.sent,Array.isArray(this.stories)||(console.error("Failed to get array from IndexedDB, using empty array"),this.stories=[]);case 10:return n=this.stories.filter((function(e){return e&&e.id&&o.favorites.includes(e.id)})),e.next=13,this.saveFavoritesToIndexedDB(n);case 13:return e.next=15,this.addOfflineAction("toggleFavorite",{storyId:r,isFavorite:!t});case 15:return e.abrupt("return",{error:!1,message:t?"Removed from favorites":"Added to favorites"});case 18:return e.prev=18,e.t0=e.catch(3),console.error("Error in toggleFavorite:",e.t0),e.abrupt("return",{error:!0,message:"Failed to update favorites. Please try again."});case 22:case"end":return e.stop()}}),e,this,[[3,18]])}))),function(e){return m.apply(this,arguments)})},{key:"getFavoriteStories",value:(g=h(l().mark((function e(){var r,t=this;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.getStories();case 3:if(r=e.sent,Array.isArray(r)){e.next=7;break}return console.error("Stories is not an array:",r),e.abrupt("return",[]);case 7:return e.abrupt("return",r.filter((function(e){return t.favorites.includes(e.id)})));case 10:return e.prev=10,e.t0=e.catch(0),console.error("Error getting favorite stories:",e.t0),e.abrupt("return",[]);case 14:case"end":return e.stop()}}),e,this,[[0,10]])}))),function(){return g.apply(this,arguments)})},{key:"isStoryFavorited",value:(b=h(l().mark((function e(r){return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.favorites.includes(r));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return b.apply(this,arguments)})},{key:"addStoryToFavorites",value:(v=h(l().mark((function e(r){var t,n=this;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,r&&r.id){e.next=4;break}return console.error("Invalid story object:",r),e.abrupt("return",!1);case 4:if(this.favorites.includes(r.id)){e.next=18;break}if(this.favorites.push(r.id),localStorage.setItem("favorites",JSON.stringify(this.favorites)),Array.isArray(this.stories)){e.next=13;break}return console.error("this.stories is not an array in addStoryToFavorites"),e.next=11,this.getStoriesFromIndexedDB();case 11:this.stories=e.sent,Array.isArray(this.stories)||(console.error("Failed to get array from IndexedDB, using empty array"),this.stories=[]);case 13:return this.stories.some((function(e){return e.id===r.id}))||this.stories.push(r),t=this.stories.filter((function(e){return e&&e.id&&n.favorites.includes(e.id)})),e.next=17,this.saveFavoritesToIndexedDB(t);case 17:return e.abrupt("return",!0);case 18:return e.abrupt("return",!1);case 21:return e.prev=21,e.t0=e.catch(0),console.error("Error in addStoryToFavorites:",e.t0),e.abrupt("return",!1);case 25:case"end":return e.stop()}}),e,this,[[0,21]])}))),function(e){return v.apply(this,arguments)})},{key:"removeStoryFromFavorites",value:(y=h(l().mark((function e(r){var t,n=this;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,r){e.next=4;break}return console.error("Invalid storyId:",r),e.abrupt("return",!1);case 4:if(!this.favorites.includes(r)){e.next=17;break}if(this.favorites=this.favorites.filter((function(e){return e!==r})),localStorage.setItem("favorites",JSON.stringify(this.favorites)),Array.isArray(this.stories)){e.next=13;break}return console.error("this.stories is not an array in removeStoryFromFavorites"),e.next=11,this.getStoriesFromIndexedDB();case 11:this.stories=e.sent,Array.isArray(this.stories)||(console.error("Failed to get array from IndexedDB, using empty array"),this.stories=[]);case 13:return t=this.stories.filter((function(e){return e&&e.id&&n.favorites.includes(e.id)})),e.next=16,this.saveFavoritesToIndexedDB(t);case 16:return e.abrupt("return",!0);case 17:return e.abrupt("return",!1);case 20:return e.prev=20,e.t0=e.catch(0),console.error("Error in removeStoryFromFavorites:",e.t0),e.abrupt("return",!1);case 24:case"end":return e.stop()}}),e,this,[[0,20]])}))),function(e){return y.apply(this,arguments)})},{key:"subscribePush",value:(d=h(l().mark((function e(r){var t,n,o;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.token){e.next=2;break}return e.abrupt("return",{success:!0});case 2:return e.prev=2,t={endpoint:r.endpoint,keys:{p256dh:btoa(String.fromCharCode.apply(null,new Uint8Array(r.getKey("p256dh")))),auth:btoa(String.fromCharCode.apply(null,new Uint8Array(r.getKey("auth"))))}},e.next=6,fetch("".concat(this.API_BASE_URL,"/notifications/subscribe"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(this.token)},body:JSON.stringify(t)});case 6:return n=e.sent,e.next=9,n.json();case 9:return(o=e.sent).error&&console.warn("Push subscription warning:",o.message),e.abrupt("return",o);case 14:return e.prev=14,e.t0=e.catch(2),console.warn("Push subscription error:",e.t0),e.abrupt("return",{success:!1,message:e.t0.message});case 18:case"end":return e.stop()}}),e,this,[[2,14]])}))),function(e){return d.apply(this,arguments)})},{key:"getStoryDetail",value:(f=h(l().mark((function e(r){var t,n,o,a;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!navigator.onLine){e.next=13;break}return e.next=4,fetch("".concat(this.API_BASE_URL,"/stories/").concat(r),{headers:{Authorization:"Bearer ".concat(this.token)}});case 4:return t=e.sent,e.next=7,t.json();case 7:if(!(n=e.sent).error){e.next=10;break}throw new Error(n.message);case 10:return e.abrupt("return",n.story);case 13:return e.next=15,this.getStoriesFromIndexedDB();case 15:if(o=e.sent,a=o.find((function(e){return e.id===r}))){e.next=19;break}throw new Error("Story not found in offline storage");case 19:return e.abrupt("return",a);case 20:e.next=25;break;case 22:throw e.prev=22,e.t0=e.catch(0),new Error("Failed to get story detail: ".concat(e.t0.message));case 25:case"end":return e.stop()}}),e,this,[[0,22]])}))),function(e){return f.apply(this,arguments)})},{key:"deleteStoryFromIndexedDB",value:(u=h(l().mark((function e(r){var t,n,o,a=this;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.db&&r){e.next=2;break}return e.abrupt("return",!1);case 2:return e.prev=2,t=this.db.transaction("stories","readwrite"),n=t.objectStore("stories"),o=n.delete(r),this.db.transaction("favorites","readwrite").objectStore("favorites").delete(r),e.abrupt("return",new Promise((function(e,t){o.onsuccess=function(){a.stories=a.stories.filter((function(e){return e.id!==r})),a.favorites.includes(r)&&(a.favorites=a.favorites.filter((function(e){return e!==r})),localStorage.setItem("favorites",JSON.stringify(a.favorites))),e({error:!1,message:"Story deleted successfully"})},o.onerror=function(e){console.error("Error deleting story from IndexedDB:",e.target.error),t({error:!0,message:"Failed to delete story"})}})));case 12:return e.prev=12,e.t0=e.catch(2),console.error("Error in deleteStoryFromIndexedDB:",e.t0),e.abrupt("return",{error:!0,message:"Failed to delete story: "+e.t0.message});case 16:case"end":return e.stop()}}),e,this,[[2,12]])}))),function(e){return u.apply(this,arguments)})},{key:"updateStoryInIndexedDB",value:(a=h(l().mark((function e(r,t){var n,a,s=this;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.db&&r){e.next=2;break}return e.abrupt("return",!1);case 2:return e.prev=2,n=this.db.transaction("stories","readwrite"),a=n.objectStore("stories"),e.abrupt("return",new Promise((function(e,n){var i=a.get(r);i.onsuccess=function(){var c=i.result;if(c){var u=o(o(o({},c),t),{},{id:r,createdAt:c.createdAt,lastUpdated:(new Date).toISOString()}),f=a.put(u);f.onsuccess=function(){s.stories=s.stories.map((function(e){return e.id===r?u:e})),s.favorites.includes(r)&&s.db.transaction("favorites","readwrite").objectStore("favorites").put(u),e({error:!1,message:"Story updated successfully",story:u})},f.onerror=function(e){console.error("Error updating story in IndexedDB:",e.target.error),n({error:!0,message:"Failed to update story"})}}else n({error:!0,message:"Story not found"})},i.onerror=function(e){console.error("Error getting story for update:",e.target.error),n({error:!0,message:"Failed to get story for update"})}})));case 8:return e.prev=8,e.t0=e.catch(2),console.error("Error in updateStoryInIndexedDB:",e.t0),e.abrupt("return",{error:!0,message:"Failed to update story: "+e.t0.message});case 12:case"end":return e.stop()}}),e,this,[[2,8]])}))),function(e,r){return a.apply(this,arguments)})},{key:"deleteStory",value:(n=h(l().mark((function e(r){var t,n;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!navigator.onLine||!this.token){e.next=15;break}return e.next=4,fetch("".concat(this.API_BASE_URL,"/stories/").concat(r),{method:"DELETE",headers:{Authorization:"Bearer ".concat(this.token)}});case 4:return t=e.sent,e.next=7,t.json();case 7:if(!(n=e.sent).error){e.next=10;break}throw new Error(n.message||"Failed to delete story from server");case 10:return e.next=12,this.deleteStoryFromIndexedDB(r);case 12:return e.abrupt("return",{error:!1,message:"Story deleted successfully"});case 15:return e.next=17,this.deleteStoryFromIndexedDB(r);case 17:return e.next=19,this.addOfflineAction("deleteStory",{storyId:r});case 19:return e.abrupt("return",{error:!1,message:"Story deleted (offline mode). It will be synced when you're back online."});case 20:e.next=26;break;case 22:return e.prev=22,e.t0=e.catch(0),console.error("Error deleting story:",e.t0),e.abrupt("return",{error:!0,message:"Failed to delete story: "+e.t0.message});case 26:case"end":return e.stop()}}),e,this,[[0,22]])}))),function(e){return n.apply(this,arguments)})},{key:"updateStory",value:(t=h(l().mark((function e(r,t){var n,o,a,i,c;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!navigator.onLine||!this.token){e.next=18;break}return n=new FormData,Object.entries(t).forEach((function(e){var r=s(e,2),t=r[0],o=r[1];null!=o&&n.append(t,o)})),e.next=6,fetch("".concat(this.API_BASE_URL,"/stories/").concat(r),{method:"PUT",headers:{Authorization:"Bearer ".concat(this.token)},body:n});case 6:return o=e.sent,e.next=9,o.json();case 9:if(!(a=e.sent).error){e.next=12;break}throw new Error(a.message||"Failed to update story on server");case 12:return e.next=14,this.updateStoryInIndexedDB(r,t);case 14:return i=e.sent,e.abrupt("return",{error:!1,message:"Story updated successfully",story:i.story});case 18:return e.next=20,this.updateStoryInIndexedDB(r,t);case 20:return c=e.sent,e.next=23,this.addOfflineAction("updateStory",{storyId:r,updatedData:t});case 23:return e.abrupt("return",{error:!1,message:"Story updated (offline mode). It will be synced when you're back online.",story:c.story});case 24:e.next=30;break;case 26:return e.prev=26,e.t0=e.catch(0),console.error("Error updating story:",e.t0),e.abrupt("return",{error:!0,message:"Failed to update story: "+e.t0.message});case 30:case"end":return e.stop()}}),e,this,[[0,26]])}))),function(e,r){return t.apply(this,arguments)})}],r&&p(e.prototype,r),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,r,t,n,a,u,f,d,y,v,b,g,m,x,w,k,S,I,A,E,j,D,B,O,F,P,_}()}}]);